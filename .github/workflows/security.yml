# Security Workflow - Comprehensive Security Scanning
name: Security Scan

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 2ì‹œì— ì‹¤í–‰
    - cron: '0 2 * * 1'
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬
  dependency-audit:
    name: ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ë£¨íŠ¸ ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬
      run: |
        npm audit --audit-level=moderate --json > audit-root.json || true
        npm audit --audit-level=moderate
        
    - name: ë°±ì—”ë“œ ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬
      run: |
        cd server-backend
        npm audit --audit-level=moderate --json > ../audit-backend.json || true
        npm audit --audit-level=moderate
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬
      run: |
        cd frontend
        npm audit --audit-level=moderate --json > ../audit-frontend.json || true
        npm audit --audit-level=moderate
        
    - name: ë³´ì•ˆ ê°ì‚¬ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-audit-results
        path: |
          audit-root.json
          audit-backend.json
          audit-frontend.json

  # ì½”ë“œ ë³´ì•ˆ ìŠ¤ìº”
  code-security:
    name: ì½”ë“œ ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        npm ci --no-audit --no-fund
        cd server-backend && npm ci --no-audit --no-fund
        cd ../frontend && npm ci --no-audit --no-fund
        
    - name: ë°±ì—”ë“œ ë³´ì•ˆ í…ŒìŠ¤íŠ¸
      run: |
        cd server-backend
        npm run test:security:comprehensive
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ ë³´ì•ˆ ê²€ì‚¬
      run: |
        cd frontend
        npm run lint
        npm run type-check

  # Docker ë³´ì•ˆ ìŠ¤ìº”
  docker-security:
    name: Docker ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Docker ë¹Œë“œ (ë°±ì—”ë“œ)
      run: |
        cd server-backend
        docker build -t community-backend:security-scan .
        
    - name: Docker ë¹Œë“œ (í”„ë¡ íŠ¸ì—”ë“œ)
      run: |
        cd frontend
        docker build -t community-frontend:security-scan .
        
    - name: Trivy ë°±ì—”ë“œ ìŠ¤ìº”
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'community-backend:security-scan'
        format: 'sarif'
        output: 'trivy-backend.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'
        
    - name: Trivy í”„ë¡ íŠ¸ì—”ë“œ ìŠ¤ìº”
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'community-frontend:security-scan'
        format: 'sarif'
        output: 'trivy-frontend.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'
        
    - name: Trivy ê²°ê³¼ ì—…ë¡œë“œ
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-backend.sarif,trivy-frontend.sarif'

  # ì‹œí¬ë¦¿ ìŠ¤ìº”
  secret-scan:
    name: ì‹œí¬ë¦¿ ìŠ¤ìº”
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: TruffleHog ì‹œí¬ë¦¿ ìŠ¤ìº”
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

  # ë³´ì•ˆ ë³´ê³ ì„œ ìƒì„±
  security-report:
    name: ë³´ì•ˆ ë³´ê³ ì„œ ìƒì„±
    runs-on: ubuntu-latest
    needs: [dependency-audit, code-security, docker-security, secret-scan]
    if: always()
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ë³´ì•ˆ ê°ì‚¬ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        name: security-audit-results
        path: ./audit-results
        
    - name: ë³´ì•ˆ ë³´ê³ ì„œ ìƒì„±
      run: |
        echo "# ğŸ›¡ï¸ ë³´ì•ˆ ìŠ¤ìº” ë³´ê³ ì„œ" > security-report.md
        echo "**ë‚ ì§œ**: $(date)" >> security-report.md
        echo "**ë¸Œëœì¹˜**: ${{ github.ref_name }}" >> security-report.md
        echo "**ì»¤ë°‹**: ${{ github.sha }}" >> security-report.md
        echo "" >> security-report.md
        
        echo "## ğŸ“Š ìŠ¤ìº” ê²°ê³¼ ìš”ì•½" >> security-report.md
        echo "- [x] ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬" >> security-report.md
        echo "- [x] ì½”ë“œ ë³´ì•ˆ ìŠ¤ìº”" >> security-report.md
        echo "- [x] Docker ë³´ì•ˆ ìŠ¤ìº”" >> security-report.md
        echo "- [x] ì‹œí¬ë¦¿ ìŠ¤ìº”" >> security-report.md
        echo "" >> security-report.md
        
        echo "## ğŸ” ìƒì„¸ ê²°ê³¼" >> security-report.md
        echo "### ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬" >> security-report.md
        if [ -f "./audit-results/audit-root.json" ]; then
          echo "ë£¨íŠ¸ í”„ë¡œì íŠ¸: $(jq '.vulnerabilities | length' ./audit-results/audit-root.json) ê°œ ì·¨ì•½ì " >> security-report.md
        fi
        if [ -f "./audit-results/audit-backend.json" ]; then
          echo "ë°±ì—”ë“œ: $(jq '.vulnerabilities | length' ./audit-results/audit-backend.json) ê°œ ì·¨ì•½ì " >> security-report.md
        fi
        if [ -f "./audit-results/audit-frontend.json" ]; then
          echo "í”„ë¡ íŠ¸ì—”ë“œ: $(jq '.vulnerabilities | length' ./audit-results/audit-frontend.json) ê°œ ì·¨ì•½ì " >> security-report.md
        fi
        
    - name: ë³´ì•ˆ ë³´ê³ ì„œ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.md
        
    - name: ë³´ì•ˆ ë³´ê³ ì„œ ì»¤ë°‹ (main ë¸Œëœì¹˜ì¸ ê²½ìš°)
      if: github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add security-report.md
        git commit -m "ğŸ›¡ï¸ ë³´ì•ˆ ìŠ¤ìº” ë³´ê³ ì„œ ì—…ë°ì´íŠ¸" || exit 0
        git push