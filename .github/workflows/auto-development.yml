name: ìë™ ê°œë°œ ì›Œí¬í”Œë¡œìš°

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œì— TODO ìƒì„±
    - cron: '0 9 * * *'
    # ë§¤ 6ì‹œê°„ë§ˆë‹¤ ì§„í–‰ ì¶”ì 
    - cron: '0 */6 * * *'
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 10ì‹œì— ì‘ì—… í• ë‹¹
    - cron: '0 10 * * 1'
  workflow_dispatch:
    inputs:
      action:
        description: 'ì‹¤í–‰í•  ì‘ì—…'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - generate-todos
          - assign-tasks
          - track-progress

jobs:
  generate-todos:
    if: github.event_name == 'schedule' || github.event.inputs.action == 'all' || github.event.inputs.action == 'generate-todos'
    runs-on: ubuntu-latest
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          npm ci
          cd frontend && npm ci
          cd ../server-backend && npm ci
      
      - name: ìë™ TODO ìƒì„±
        run: |
          node scripts/auto-todo-generator.js
      
      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/todo-backlog.md
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            git commit -m "ğŸ¤– ìë™ TODO ìƒì„± $(date '+%Y-%m-%d %H:%M')"
            git push
          fi

  assign-tasks:
    if: github.event_name == 'schedule' || github.event.inputs.action == 'all' || github.event.inputs.action == 'assign-tasks'
    runs-on: ubuntu-latest
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
      
      - name: ìë™ ì‘ì—… í• ë‹¹
        run: |
          node scripts/auto-task-assigner.js
      
      - name: ì•Œë¦¼ ë””ë ‰í† ë¦¬ ìƒì„±
        run: mkdir -p notifications
      
      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/todo-backlog.md notifications/
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            git commit -m "ğŸ¯ ìë™ ì‘ì—… í• ë‹¹ $(date '+%Y-%m-%d %H:%M')"
            git push
          fi

  track-progress:
    if: github.event_name == 'schedule' || github.event.inputs.action == 'all' || github.event.inputs.action == 'track-progress'
    runs-on: ubuntu-latest
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
      
      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          cd frontend && npm test -- --coverage --watchAll=false
          cd ../server-backend && npm test -- --coverage --watchAll=false
      
      - name: ìë™ ì§„í–‰ ì¶”ì 
        run: |
          node scripts/auto-progress-tracker.js
      
      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/progress-report.md docs/todo-backlog.md
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            git commit -m "ğŸ“Š ì§„í–‰ ì¶”ì  ì—…ë°ì´íŠ¸ $(date '+%Y-%m-%d %H:%M')"
            git push
          fi

  notify-team:
    if: always()
    runs-on: ubuntu-latest
    needs: [generate-todos, assign-tasks, track-progress]
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: íŒ€ ì•Œë¦¼
        run: |
          echo "ğŸš€ ìë™ ê°œë°œ ì›Œí¬í”Œë¡œìš°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "ğŸ“‹ TODO ìƒì„±: ${{ needs.generate-todos.result }}"
          echo "ğŸ¯ ì‘ì—… í• ë‹¹: ${{ needs.assign-tasks.result }}"
          echo "ğŸ“Š ì§„í–‰ ì¶”ì : ${{ needs.track-progress.result }}"
      
      - name: Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­)
        if: env.SLACK_WEBHOOK_URL
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ğŸš€ ìë™ ê°œë°œ ì›Œí¬í”Œë¡œìš° ì™„ë£Œ!\nğŸ“‹ TODO ìƒì„±: ${{ needs.generate-todos.result }}\nğŸ¯ ì‘ì—… í• ë‹¹: ${{ needs.assign-tasks.result }}\nğŸ“Š ì§„í–‰ ì¶”ì : ${{ needs.track-progress.result }}"}' \
            $SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
