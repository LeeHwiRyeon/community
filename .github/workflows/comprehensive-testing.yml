name: Comprehensive Testing CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'Test scope to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - e2e
          - performance
          - security
      enable_bug_report:
        description: 'Generate bug reports on failure'
        required: false
        default: true
        type: boolean

jobs:
  comprehensive-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      mariadb:
        image: mariadb:10.6
        env:
          MARIADB_ROOT_PASSWORD: root
          MARIADB_DATABASE: community
          MARIADB_USER: app
          MARIADB_PASSWORD: app
          MARIADB_EXTRA_FLAGS: --innodb-use-native-aio=0
        ports: [ '3306:3306' ]
        options: >-
          --health-cmd "mysqladmin ping -h 127.0.0.1 -u root -proot"
          --health-interval 10s --health-timeout 5s --health-retries 12

    env:
      DB_HOST: 127.0.0.1
      DB_USER: app
      DB_PASS: app
      DB_NAME: community
      PORT: 50000
      NODE_ENV: test
      CI: true
      API_BASE: http://localhost:50000
      TEST_SCOPE: ${{ github.event.inputs.test_scope || 'all' }}

    steps:
      - uses: actions/checkout@v4

      - name: Install MariaDB client
        run: sudo apt-get update && sudo apt-get install -y mariadb-client

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            server-backend/package-lock.json
            frontend/package-lock.json

      - name: Wait for DB
        timeout-minutes: 2
        run: |
          for i in {1..40}; do
            if mysql -h 127.0.0.1 -u app -papp -e 'SELECT 1' community; then echo 'DB ready'; break; fi
            echo 'Waiting DB...'; sleep 2;
          done

      - name: Install backend dependencies
        timeout-minutes: 5
        working-directory: server-backend
        run: npm install

      - name: Install frontend dependencies
        timeout-minutes: 5
        working-directory: frontend
        run: npm install

      - name: Build frontend
        timeout-minutes: 5
        working-directory: frontend
        run: npm run build

      - name: Start backend server
        timeout-minutes: 3
        working-directory: server-backend
        run: |
          powershell -Command "Start-Job -ScriptBlock { Set-Location '${{ github.workspace }}/server-backend'; node mock-server.js } | Out-Null"
          timeout 15 bash -c 'until curl -f http://localhost:50000/api/health; do sleep 1; done' || (echo "Backend failed to start" && exit 1)

      - name: Run unit tests
        if: env.TEST_SCOPE == 'all' || env.TEST_SCOPE == 'unit'
        timeout-minutes: 5
        working-directory: frontend
        run: npm test -- --coverage --watchAll=false
        continue-on-error: true

      - name: Run integration tests
        if: env.TEST_SCOPE == 'all' || env.TEST_SCOPE == 'integration'
        timeout-minutes: 5
        working-directory: frontend
        run: npm test -- --testPathPattern=integration --watchAll=false
        continue-on-error: true

      - name: Stop backend server for E2E
        if: always()
        run: |
          powershell -Command "Get-Process node -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like '*mock-server.js*' } | Stop-Process -Force -ErrorAction SilentlyContinue"

      - name: Start servers for E2E and Content Testing
        timeout-minutes: 3
        run: |
          cd server-backend && node mock-server.js &
          sleep 10
          curl -f http://localhost:50000/api/health || (echo "Backend not ready" && exit 1)
          cd ../frontend && npm run preview &
          sleep 5
          curl -f http://localhost:5173 || (echo "Frontend not ready" && exit 1)

      - name: Run E2E tests
        if: env.TEST_SCOPE == 'all' || env.TEST_SCOPE == 'e2e'
        timeout-minutes: 10
        working-directory: server-backend
        run: |
          npx playwright install --with-deps
          npx playwright test --reporter=json
        continue-on-error: true

      - name: Run ContentTester integration test
        if: env.TEST_SCOPE == 'all' || env.TEST_SCOPE == 'integration'
        timeout-minutes: 5
        working-directory: frontend
        run: |
          # ContentTesterë¥¼ í†µí•œ ì‹¤ì œ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
          node -e "
          const { JSDOM } = require('jsdom');
          const fs = require('fs');

          // ê°„ë‹¨í•œ ContentTester ì‹œë®¬ë ˆì´ì…˜
          console.log('ðŸ§ª Running ContentTester integration...');

          // API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
          const testEndpoints = async () => {
            const endpoints = [
              'http://localhost:50000/api/boards',
              'http://localhost:50000/api/communities',
              'http://localhost:5173'
            ];

            for (const endpoint of endpoints) {
              try {
                const response = await fetch(endpoint);
                console.log(\`âœ… \${endpoint}: \${response.status}\`);
              } catch (error) {
                console.log(\`âŒ \${endpoint}: \${error.message}\`);
              }
            }
          };

          testEndpoints();
          "
        continue-on-error: true

      - name: Performance testing
        if: env.TEST_SCOPE == 'all' || env.TEST_SCOPE == 'performance'
        timeout-minutes: 5
        run: |
          echo "ðŸƒ Running performance tests..."

          # Frontend ë²ˆë“¤ ì‚¬ì´ì¦ˆ ì²´í¬
          cd frontend
          BUNDLE_SIZE=$(du -sh dist/assets/*.js | awk '{sum += $1} END {print sum}')
          echo "ðŸ“¦ Bundle size: $BUNDLE_SIZE"

          # API ì‘ë‹µ ì‹œê°„ í…ŒìŠ¤íŠ¸
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}\n' http://localhost:50000/api/health)
          echo "âš¡ API response time: ${RESPONSE_TIME}s"

          # ìž„ê³„ê°’ ì²´í¬
          if (( $(echo "$RESPONSE_TIME > 2.0" | bc -l) )); then
            echo "âš ï¸  Warning: API response time is slow"
            exit 1
          fi
        continue-on-error: true

      - name: Security testing
        if: env.TEST_SCOPE == 'all' || env.TEST_SCOPE == 'security'
        timeout-minutes: 5
        run: |
          echo "ðŸ”’ Running security tests..."

          # ê¸°ë³¸ ë³´ì•ˆ í—¤ë” ì²´í¬
          SECURITY_HEADERS=$(curl -I http://localhost:5173 2>/dev/null | grep -E "(X-Frame-Options|X-Content-Type-Options|Content-Security-Policy)" | wc -l)
          echo "ðŸ›¡ï¸  Security headers found: $SECURITY_HEADERS"

          # XSS ì·¨ì•½ì  ê¸°ë³¸ ì²´í¬
          cd frontend
          XSS_PATTERNS=$(grep -r "innerHTML\|outerHTML\|dangerouslySetInnerHTML" src/ | wc -l)
          echo "ðŸ” Potential XSS patterns found: $XSS_PATTERNS"

          if [ "$XSS_PATTERNS" -gt 0 ]; then
            echo "âš ï¸  Warning: Potential XSS vulnerabilities detected"
          fi
        continue-on-error: true

      - name: Generate test report
        if: always()
        run: |
          echo "## ðŸ§ª Comprehensive Test Report" > test-report.md
          echo "" >> test-report.md
          echo "### ðŸ“Š Test Summary" >> test-report.md
          echo "- **Date:** $(date)" >> test-report.md
          echo "- **Commit:** ${{ github.sha }}" >> test-report.md
          echo "- **Branch:** ${{ github.ref }}" >> test-report.md
          echo "- **Test Scope:** $TEST_SCOPE" >> test-report.md
          echo "" >> test-report.md

          echo "### ðŸ” Test Results" >> test-report.md

          # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê²°ê³¼
          if [ -f "frontend/coverage/lcov-report/index.html" ]; then
            echo "#### âœ… Unit Tests" >> test-report.md
            echo "- Coverage report generated" >> test-report.md
          fi

          # E2E í…ŒìŠ¤íŠ¸ ê²°ê³¼
          if [ -f "server-backend/test-results/index.html" ]; then
            echo "#### âœ… E2E Tests" >> test-report.md
            echo "- Playwright report generated" >> test-report.md
          fi

          echo "" >> test-report.md
          echo "### ðŸš¨ Issues Found" >> test-report.md

          # ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ë“¤ ì •ë¦¬
          echo "#### Failed Tests:" >> test-report.md
          echo "- Check individual test outputs above" >> test-report.md

          echo "" >> test-report.md
          echo "### ðŸ“ˆ Performance Metrics" >> test-report.md
          echo "- Bundle size, API response times logged above" >> test-report.md

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-test-results-${{ github.run_number }}
          path: |
            frontend/coverage/
            server-backend/test-results/
            playwright-report/
            test-report.md
          retention-days: 30

      - name: Generate bug report
        if: failure() && github.event.inputs.enable_bug_report != 'false'
        run: |
          echo "## ðŸ› Bug Report" > bug-report.md
          echo "" >> bug-report.md
          echo "### ðŸ“‹ Issue Details" >> bug-report.md
          echo "- **Date:** $(date)" >> bug-report.md
          echo "- **Workflow:** Comprehensive Testing CI" >> bug-report.md
          echo "- **Commit:** ${{ github.sha }}" >> bug-report.md
          echo "- **Triggered by:** ${{ github.actor }}" >> bug-report.md
          echo "" >> bug-report.md

          echo "### ðŸ” Failure Analysis" >> bug-report.md
          echo "\`\`\`" >> bug-report.md
          echo "Check the job logs above for detailed error messages" >> bug-report.md
          echo "\`\`\`" >> bug-report.md
          echo "" >> bug-report.md

          echo "### ðŸ› ï¸ Recommended Actions" >> bug-report.md
          echo "1. Review test failures in the artifacts" >> bug-report.md
          echo "2. Check application logs for errors" >> bug-report.md
          echo "3. Verify database connectivity" >> bug-report.md
          echo "4. Test API endpoints manually" >> bug-report.md
          echo "" >> bug-report.md

          echo "### ðŸ“Š System Information" >> bug-report.md
          echo "- **OS:** Ubuntu Latest" >> bug-report.md
          echo "- **Node.js:** 20" >> bug-report.md
          echo "- **Database:** MariaDB 10.6" >> bug-report.md

      - name: Upload bug report
        if: failure() && github.event.inputs.enable_bug_report != 'false'
        uses: actions/upload-artifact@v4
        with:
          name: bug-report-${{ github.run_number }}
          path: bug-report.md
          retention-days: 30

      - name: Cleanup all processes
        if: always()
        run: |
          # Kill all Node.js processes
          powershell -Command "Get-Process node -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue"
          # Kill processes on test ports
          powershell -Command "Get-NetTCPConnection -LocalPort 50000,5173,9323 -ErrorAction SilentlyContinue | Stop-Process -Id { $_.OwningProcess } -Force -ErrorAction SilentlyContinue"
          # Kill any remaining test processes
          powershell -Command "Get-Process -Name 'chrome', 'firefox', 'webkit' -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue"