# CI Pipeline - Security Hardened
name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'
  BACKEND_PORT: 50000
  FRONTEND_PORT: 3000

jobs:
  # ë³´ì•ˆ ê²€ì‚¬
  security-audit:
    name: ë³´ì•ˆ ê°ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ë£¨íŠ¸ ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬
      run: npm audit --audit-level=moderate
      
    - name: ë°±ì—”ë“œ ë³´ì•ˆ ê°ì‚¬
      run: |
        cd server-backend
        npm audit --audit-level=moderate
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ ë³´ì•ˆ ê°ì‚¬
      run: |
        cd frontend
        npm audit --audit-level=moderate

  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  code-quality:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    needs: security-audit
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ë°±ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd server-backend
        npm ci --no-audit --no-fund
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd frontend
        npm ci --no-audit --no-fund
        
    - name: ë°±ì—”ë“œ ë¦°íŒ…
      run: |
        cd server-backend
        npm run lint
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ ë¦°íŒ…
      run: |
        cd frontend
        npm run lint

  # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ë°±ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd server-backend
        npm ci --no-audit --no-fund
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd frontend
        npm ci --no-audit --no-fund
        
    - name: ë°±ì—”ë“œ ë³´ì•ˆ í…ŒìŠ¤íŠ¸
      run: |
        cd server-backend
        npm run test:security
        
    - name: ë°±ì—”ë“œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
      run: |
        cd server-backend
        npm run test:unit
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸
      run: |
        cd frontend
        npm run test:run

  # ë¹Œë“œ í…ŒìŠ¤íŠ¸
  build:
    name: ë¹Œë“œ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ë°±ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd server-backend
        npm ci --only=production --no-audit --no-fund
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd frontend
        npm ci --no-audit --no-fund
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      run: |
        cd frontend
        npm run build
        
    - name: ë°±ì—”ë“œ ë¹Œë“œ í™•ì¸
      run: |
        cd server-backend
        npm run build

  # Docker ë³´ì•ˆ ê²€ì‚¬
  docker-security:
    name: Docker ë³´ì•ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Docker ë¹Œë“œ (ë°±ì—”ë“œ)
      run: |
        cd server-backend
        docker build -t community-backend:test .
        
    - name: Docker ë¹Œë“œ (í”„ë¡ íŠ¸ì—”ë“œ)
      run: |
        cd frontend
        docker build -t community-frontend:test .
        
    - name: Docker ë³´ì•ˆ ìŠ¤ìº” (Trivy)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'community-backend:test'
        format: 'sarif'
        output: 'trivy-results-backend.sarif'
        
    - name: Docker ë³´ì•ˆ ìŠ¤ìº” (Trivy) - Frontend
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'community-frontend:test'
        format: 'sarif'
        output: 'trivy-results-frontend.sarif'
        
    - name: Trivy ê²°ê³¼ ì—…ë¡œë“œ
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results-backend.sarif,trivy-results-frontend.sarif'

  # ============================================================================
  # ğŸ“¢ Slack ì•Œë¦¼
  # ============================================================================
  slack-notification:
    name: Slack ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [security-audit, code-quality, test, build, docker-security]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¢ Slack CI Success Notification
        if: needs.security-audit.result == 'success' && needs.code-quality.result == 'success' && needs.test.result == 'success' && needs.build.result == 'success' && needs.docker-security.result == 'success'
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "âš ï¸ SLACK_WEBHOOK_URL not configured, skipping notification"
            exit 0
          fi
          echo "ğŸ“¢ Sending Slack CI success notification..."
          node slack-notifications.js task "CI Pipeline ì™„ë£Œ" \
            --build=success \
            --errors=0 \
            --files=0

      - name: ğŸ“¢ Slack CI Failure Notification
        if: needs.security-audit.result == 'failure' || needs.code-quality.result == 'failure' || needs.test.result == 'failure' || needs.build.result == 'failure' || needs.docker-security.result == 'failure'
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "âš ï¸ SLACK_WEBHOOK_URL not configured, skipping notification"
            exit 0
          fi
          echo "ğŸ“¢ Sending Slack CI failure notification..."
          node slack-notifications.js error "CI Pipeline ì‹¤íŒ¨" \
            --file=ci.yml \
            --count=1