# CI Pipeline - Security Hardened
name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'
  BACKEND_PORT: 50000
  FRONTEND_PORT: 3000

jobs:
  # 보안 검사
  security-audit:
    name: 보안 감사
    runs-on: ubuntu-latest
    
    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v4
      
    - name: Node.js 설정
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: 루트 의존성 보안 감사
      run: npm audit --audit-level=moderate
      
    - name: 백엔드 보안 감사
      run: |
        cd server-backend
        npm audit --audit-level=moderate
        
    - name: 프론트엔드 보안 감사
      run: |
        cd frontend
        npm audit --audit-level=moderate

  # 코드 품질 검사
  code-quality:
    name: 코드 품질 검사
    runs-on: ubuntu-latest
    needs: security-audit
    
    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v4
      
    - name: Node.js 설정
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: 백엔드 의존성 설치
      run: |
        cd server-backend
        npm ci --no-audit --no-fund
        
    - name: 프론트엔드 의존성 설치
      run: |
        cd frontend
        npm ci --no-audit --no-fund
        
    - name: 백엔드 린팅
      run: |
        cd server-backend
        npm run lint
        
    - name: 프론트엔드 린팅
      run: |
        cd frontend
        npm run lint

  # 테스트 실행
  test:
    name: 테스트 실행
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v4
      
    - name: Node.js 설정
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: 백엔드 의존성 설치
      run: |
        cd server-backend
        npm ci --no-audit --no-fund
        
    - name: 프론트엔드 의존성 설치
      run: |
        cd frontend
        npm ci --no-audit --no-fund
        
    - name: 백엔드 보안 테스트
      run: |
        cd server-backend
        npm run test:security
        
    - name: 백엔드 단위 테스트
      run: |
        cd server-backend
        npm run test:unit
        
    - name: 프론트엔드 테스트
      run: |
        cd frontend
        npm run test:run

  # 빌드 테스트
  build:
    name: 빌드 테스트
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v4
      
    - name: Node.js 설정
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: 백엔드 의존성 설치
      run: |
        cd server-backend
        npm ci --only=production --no-audit --no-fund
        
    - name: 프론트엔드 의존성 설치
      run: |
        cd frontend
        npm ci --no-audit --no-fund
        
    - name: 프론트엔드 빌드
      run: |
        cd frontend
        npm run build
        
    - name: 백엔드 빌드 확인
      run: |
        cd server-backend
        npm run build

  # Docker 보안 검사
  docker-security:
    name: Docker 보안 검사
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v4
      
    - name: Docker 빌드 (백엔드)
      run: |
        cd server-backend
        docker build -t community-backend:test .
        
    - name: Docker 빌드 (프론트엔드)
      run: |
        cd frontend
        docker build -t community-frontend:test .
        
    - name: Docker 보안 스캔 (Trivy)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'community-backend:test'
        format: 'sarif'
        output: 'trivy-results-backend.sarif'
        
    - name: Docker 보안 스캔 (Trivy) - Frontend
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'community-frontend:test'
        format: 'sarif'
        output: 'trivy-results-frontend.sarif'
        
    - name: Trivy 결과 업로드
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results-backend.sarif,trivy-results-frontend.sarif'