_format_version: "3.0"

services:
  # 인증 서비스
  - name: auth-service
    url: http://auth-service:3001
    routes:
      - name: auth-routes
        paths:
          - /api/auth
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        strip_path: true
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
      - name: cors
        config:
          origins:
            - "http://localhost:3000"
            - "https://community.example.com"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - X-Auth-Token
          credentials: true

  # 사용자 서비스
  - name: user-service
    url: http://user-service:3002
    routes:
      - name: user-routes
        paths:
          - /api/users
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        strip_path: true
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
          key_claim_name: iss
          uri_param_names:
            - jwt
          claims_to_verify:
            - exp
      - name: rate-limiting
        config:
          minute: 200
          hour: 2000

  # 콘텐츠 서비스
  - name: content-service
    url: http://content-service:3003
    routes:
      - name: content-routes
        paths:
          - /api/posts
          - /api/comments
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        strip_path: true
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
          key_claim_name: iss
          uri_param_names:
            - jwt
          claims_to_verify:
            - exp
      - name: rate-limiting
        config:
          minute: 300
          hour: 3000

  # 알림 서비스
  - name: notification-service
    url: http://notification-service:3004
    routes:
      - name: notification-routes
        paths:
          - /api/notifications
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        strip_path: true
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
          key_claim_name: iss
          uri_param_names:
            - jwt
          claims_to_verify:
            - exp
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000

  # 분석 서비스
  - name: analytics-service
    url: http://analytics-service:3005
    routes:
      - name: analytics-routes
        paths:
          - /api/analytics
        methods:
          - GET
          - POST
        strip_path: true
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
          key_claim_name: iss
          uri_param_names:
            - jwt
          claims_to_verify:
            - exp
      - name: rate-limiting
        config:
          minute: 50
          hour: 500

  # 검색 서비스
  - name: search-service
    url: http://search-service:3006
    routes:
      - name: search-routes
        paths:
          - /api/search
        methods:
          - GET
          - POST
        strip_path: true
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
          key_claim_name: iss
          uri_param_names:
            - jwt
          claims_to_verify:
            - exp
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000

  # 파일 서비스
  - name: file-service
    url: http://file-service:3007
    routes:
      - name: file-routes
        paths:
          - /api/files
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        strip_path: true
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
          key_claim_name: iss
          uri_param_names:
            - jwt
          claims_to_verify:
            - exp
      - name: rate-limiting
        config:
          minute: 200
          hour: 2000

  # 채팅 서비스
  - name: chat-service
    url: http://chat-service:3008
    routes:
      - name: chat-routes
        paths:
          - /api/chat
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        strip_path: true
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
          key_claim_name: iss
          uri_param_names:
            - jwt
          claims_to_verify:
            - exp
      - name: rate-limiting
        config:
          minute: 500
          hour: 5000

  # 관리자 서비스
  - name: admin-service
    url: http://admin-service:3009
    routes:
      - name: admin-routes
        paths:
          - /api/admin
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        strip_path: true
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
          key_claim_name: iss
          uri_param_names:
            - jwt
          claims_to_verify:
            - exp
      - name: rate-limiting
        config:
          minute: 50
          hour: 500

# 글로벌 플러그인
plugins:
  - name: prometheus
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true

  - name: request-transformer
    config:
      add:
        headers:
          - "X-Request-ID:${request_id}"
          - "X-Forwarded-For:${client_ip}"

  - name: response-transformer
    config:
      add:
        headers:
          - "X-Response-Time:${latency}"
          - "X-Service-Version:${service_version}"

# 업스트림 (로드 밸런싱)
upstreams:
  - name: auth-service-upstream
    targets:
      - target: auth-service:3001
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 30
          successes: 1
        unhealthy:
          interval: 10
          http_failures: 3

  - name: user-service-upstream
    targets:
      - target: user-service:3002
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 30
          successes: 1
        unhealthy:
          interval: 10
          http_failures: 3

  - name: content-service-upstream
    targets:
      - target: content-service:3003
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 30
          successes: 1
        unhealthy:
          interval: 10
          http_failures: 3

# 컨슈머 (API 키 관리)
consumers:
  - username: web-client
    keyauth_credentials:
      - key: web-client-key-12345
    acls:
      - group: web-clients

  - username: mobile-client
    keyauth_credentials:
      - key: mobile-client-key-67890
    acls:
      - group: mobile-clients

  - username: admin-client
    keyauth_credentials:
      - key: admin-client-key-abcdef
    acls:
      - group: admin-clients

# ACL 그룹
acls:
  - group: web-clients
    tags:
      - web

  - group: mobile-clients
    tags:
      - mobile

  - group: admin-clients
    tags:
      - admin