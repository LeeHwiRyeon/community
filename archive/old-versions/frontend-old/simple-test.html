<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>ê°„ë‹¨ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ (frontend/)</title>
    <!--
            NOTE: ìƒˆë¡œìš´ ë°±ì—”ë“œ ì—”ë“œí¬ì¸íŠ¸(ì˜ˆ: /api/xxx) ì¶”ê°€ ì‹œ
            1) ì•„ë˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ buildTests() ë°°ì—´ì— í…ŒìŠ¤íŠ¸ í•­ëª©ì„ ì¶”ê°€í•˜ê³ 
            2) í•„ìš”í•˜ë©´ ì „ìš© UI ì¹´ë“œ(.test div) + ìˆ˜ë™ ë²„íŠ¼ë„ êµ¬ì„±
            3) ì„±ëŠ¥ ì¸¡ì •ì´ í•„ìš”í•œ ê²½ìš° performance.now() ë¡œ ms ê¸°ë¡ í›„ mark(extra)ì— í‘œê¸°
            4) ì¬ì‹œë„ ëŒ€ìƒ í¬í•¨í•˜ë ¤ë©´ key ê³ ìœ ê°’ ë¶€ì—¬ (ê¸°ì¡´ê³¼ ì¤‘ë³µ ê¸ˆì§€)
            5) ê²°ê³¼ êµ¬ì¡°ëŠ” CHECK_RESULTS[key] = { ok, extra, ms, raw } í˜•íƒœ ìœ ì§€
        -->
    <style>
        body {
            font-family: Arial;
            padding: 20px;
            background: #f5f5f5;
        }

        .test {
            background: #fff;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007acc;
        }

        button {
            background: #007acc;
            color: #fff;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }

        button:hover {
            background: #005999;
        }

        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>

<body>
    <h1>ğŸš€ ì»¤ë®¤ë‹ˆí‹° í”Œë«í¼ ì¢…í•© í…ŒìŠ¤íŠ¸ (ë‹¨ì¼ ì²´í¬ë¦¬ìŠ¤íŠ¸)</h1>
    <p style="font-size:12px;color:#666;">ëª¨ë“  í…ŒìŠ¤íŠ¸ëŠ” ì•„ë˜ "ë¹ ë¥¸ ê¸°ëŠ¥ ì²´í¬ë¦¬ìŠ¤íŠ¸" ì— í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤. ì‹¤íŒ¨ê°€ ë°œìƒí•´ë„ ì¤‘ë‹¨í•˜ì§€ ì•Šê³  ëê¹Œì§€ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p>

    <!-- ìƒˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ -->
    <div class="test" id="checklist-box">
        <h3>âœ… ë¹ ë¥¸ ê¸°ëŠ¥ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
        <div style="font-size:12px;color:#555;line-height:1.4;">ì•„ë˜ í•­ëª©ì„ ìˆœì„œëŒ€ë¡œ ìë™ ì ê²€í•˜ê±°ë‚˜, ê°œë³„ ì‹¤í–‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê¸°ëŠ¥ì„ ê²€ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        <div style="margin:6px 0;">
            <button onclick="runChecklist()" style="background:#2f855a;">ì²´í¬ë¦¬ìŠ¤íŠ¸ ì‹¤í–‰</button>
            <button onclick="retryFailed()" style="background:#b45309;">ì‹¤íŒ¨ë§Œ ì¬ì‹œë„</button>
            <button onclick="resetChecklist()" style="background:#6b7280;">ì´ˆê¸°í™”</button>
            <button onclick="exportChecklistJson()" style="background:#1d4ed8;">JSON Export</button>
        </div>
        <ul id="checklist" style="list-style:none;padding-left:0;margin:0;font-size:13px;line-height:1.5;">
            <li id="cl-health">[ ] Health API</li>
            <li id="cl-help">[ ] Help API</li>
            <li id="cl-metrics">[ ] Metrics API</li>
            <li id="cl-trending">[ ] Trending (ì‘ë‹µ/ì†ŒìŠ¤)</li>
            <li id="cl-trending-perf">[ ] Trending ì„±ëŠ¥(5íšŒ avg)</li>
            <li id="cl-home">[ ] /home í†µí•©</li>
            <li id="cl-search">[ ] ê²€ìƒ‰(Search)</li>
            <li id="cl-boards">[ ] Boards ëª©ë¡</li>
            <li id="cl-categories">[ ] Categories ëª©ë¡</li>
            <li id="cl-metrics-latency">[ ] Metrics p95 ê²€ì‚¬</li>
            <li id="cl-chat-load">[ ] Chat ë¶€í•˜</li>
            <li id="cl-login">[ ] Google ë¡œê·¸ì¸ (test-mode ê°€ëŠ¥)</li>
            <li id="cl-me">[ ] /auth/me (identities í¬í•¨)</li>
            <li id="cl-post">[ ] ê²Œì‹œê¸€ ì‘ì„± & ìƒì„¸(author í™•ì¸)</li>
            <li id="cl-chat">[ ] ì±„íŒ… ì „ì†¡ & ì¡°íšŒ</li>
            <li id="cl-latest500">[ ] ìµœì‹  ì±„íŒ… 500 ë¡œë“œ</li>
            <li id="cl-security">[ ] ë³´ì•ˆ í—¤ë”(CSP)</li>
        </ul>
        <div id="checklist-log" class="result info" style="margin-top:8px;">ëŒ€ê¸° ì¤‘</div>
    </div>

    <div class="test" id="google-auth-box">
        <h3>ğŸ” êµ¬ê¸€ ë¡œê·¸ì¸</h3>
        <div style="font-size:12px;color:#555;line-height:1.4;">
            ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¡œê·¸ì¸ ì°½ì„ ì§ì ‘ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (Google One Tap ìë™ ë²„íŠ¼ + ì»¤ìŠ¤í…€ ë‘˜ ë‹¤ ì œê³µ)
        </div>
        <div style="margin:6px 0;">
            <button id="custom-google-btn" style="background:#DB4437;">â–¶ êµ¬ê¸€ ë¡œê·¸ì¸ ì°½ ì—´ê¸°</button>
            <button onclick="testGoogleTestMode()" style="background:#555;">(í…ŒìŠ¤íŠ¸) test-mode í† í° ë¡œê·¸ì¸</button>
            <button onclick="fetchMe()" style="background:#444;">/me ì¡°íšŒ</button>
            <button onclick="logoutAll()" style="background:#9d174d;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <div id="g_id_signin" style="margin-top:4px;"></div>
        <div id="google-login-result" class="result info">ë¯¸ë¡œê·¸ì¸</div>
    </div>

    <div class="test" id="post-create-box">
        <h3>âœï¸ ë¡œê·¸ì¸ í›„ ê²Œì‹œê¸€ ì‘ì„± í…ŒìŠ¤íŠ¸</h3>
        <div style="font-size:12px;color:#555;">êµ¬ê¸€ ë¡œê·¸ì¸(Test-mode ê°€ëŠ¥) â†’ í† í° ì €ì¥ â†’ ì•„ë˜ì—ì„œ ê¸€ ì‘ì„± (author ìë™ = display_name)
        </div>
        <label>ê²Œì‹œíŒ ID: <input type="text" id="post-board" value="free" style="width:120px;" /></label>
        <br />
        <input type="text" id="post-title" placeholder="ì œëª©" value="í…ŒìŠ¤íŠ¸ ì œëª©" style="width:300px;" />
        <br />
        <textarea id="post-content" placeholder="ë‚´ìš©" style="width:300px;height:80px;">ê°„ë‹¨ ë‚´ìš©</textarea>
        <br />
        <button onclick="createPost()">ê¸€ ì‘ì„±</button>
        <div id="post-create-result" class="result info">ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”</div>
    </div>

    <!-- ì´ì „ auto-suite ì œê±°: global-suite + checklist í†µí•©ìœ¼ë¡œ ëŒ€ì²´ -->

    <div class="test">
        <h3>ğŸ” ì„œë²„ ìƒíƒœ</h3>
        <button onclick="test('health')">Health Check</button>
        <button onclick="test('help')">API ë¬¸ì„œ</button>
        <button onclick="test('metrics')">ë©”íŠ¸ë¦­ìŠ¤</button>
        <div id="server-result" class="result"></div>
    </div>

    <div class="test">
        <h3>âš¡ Trending API (Redis ìµœì í™”)</h3>
        <button onclick="test('trending')">ë‹¨ì¼ ìš”ì²­</button>
        <button onclick="testPerformance()">ì„±ëŠ¥ í…ŒìŠ¤íŠ¸</button>
        <div id="trending-result" class="result"></div>
    </div>

    <div class="test">
        <h3>ğŸ† Trending/Ranking ìƒ˜í”Œ ë‹¤íšŒ í˜¸ì¶œ</h3>
        <div style="font-size:12px;color:#555;">Redis ë©”ëª¨ë¦¬ ìºì‹œ(source=memory_cache) ì „í™˜ ë° í‰ê·  ì‹œê°„ ê´€ì°°</div>
        <button onclick="multiTrending()" style="background:#9333ea;">10íšŒ ì—°ì† í˜¸ì¶œ</button>
        <div id="trending-multi-result" class="result"></div>
    </div>

    <div class="test">
        <h3>ğŸ’¬ ì±„íŒ… ê¸°ëŠ¥</h3>
        <input type="text" id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥" value="í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€" />
        <button onclick="sendMessage()">ì „ì†¡</button>
        <button onclick="sendRandomMessage()" style="background:#7c3aed;">ëœë¤ ì „ì†¡</button>
        <button onclick="test('chat')">ì¡°íšŒ</button>
        <div id="chat-result" class="result"></div>
    </div>

    <div class="test">
        <h3>ğŸ§ª Chat ë¶€í•˜ í…ŒìŠ¤íŠ¸</h3>
        <div style="font-size:12px;color:#555;">NíšŒ ë³‘ë ¬ ì „ì†¡ í›„ ì„œë²„ ì‘ë‹µì‹œê°„ í†µê³„(ms) ì‚°ì¶œ</div>
        <label>ì´ ë©”ì‹œì§€ ìˆ˜ N: <input type="number" id="chat-load-n" value="30" style="width:80px;" /></label>
        <label>ë™ì‹œì„±(concurrency): <input type="number" id="chat-load-c" value="5" style="width:60px;" /></label>
        <button onclick="runChatLoad()" style="background:#dc2626;">ì‹¤í–‰</button>
        <div id="chat-load-result" class="result info">ëŒ€ê¸° ì¤‘</div>
    </div>

    <div class="test">
        <h3>ğŸ›¡ï¸ ë³´ì•ˆ í—¤ë”</h3>
        <button onclick="checkSecurity()">ë³´ì•ˆ í™•ì¸</button>
        <div id="security-result" class="result"></div>
    </div>

    <div class="test">
        <h3>ğŸ§µ ìµœì‹  ì±„íŒ… 500 (ëª¨ë“  ì»¤ë®¤ë‹ˆí‹°)</h3>
        <button onclick="loadLatest500()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button onclick="autoRefreshLatest()">30ì´ˆ ìë™ê°±ì‹  ì‹œì‘</button>
        <button onclick="stopAutoRefreshLatest()">ìë™ê°±ì‹  ì¤‘ì§€</button>
        <div style="font-size:12px;color:#555;">ê° ì»¤ë®¤ë‹ˆí‹° ë³„ Redis/DB ìµœì‹  ë©”ì‹œì§€ í•©ì‚° í›„ timestamp ì—­ìˆœ ì •ë ¬ â†’ ìƒìœ„ 500 í‘œì‹œ</div>
        <div id="latest500-summary" class="result info">ì•„ì§ ë¡œë“œ ì•ˆë¨</div>
        <div id="latest500-list" class="result"
            style="max-height:300px; overflow-y:auto; background:#fff; border:1px solid #ddd;"></div>
    </div>

    <script>
        const API = 'http://localhost:50000/api';
        let ACCESS_TOKEN = null;
        function show(id, text, type = 'info') { const el = document.getElementById(id); if (!el) return; el.className = `result ${type}`; el.textContent = text; }
        async function request(url, opt = {}) { try { const headers = { 'Content-Type': 'application/json', ...(opt.headers || {}) }; if (ACCESS_TOKEN) headers['Authorization'] = 'Bearer ' + ACCESS_TOKEN; const r = await fetch(url, { ...opt, headers }); const data = await r.json().catch(() => ({})); if (!r.ok) throw new Error(data.error || 'HTTP ' + r.status); return { ok: true, data, headers: r.headers }; } catch (e) { return { ok: false, error: e.message }; } }
        async function test(kind) {
            const map = {
                health: async () => { const r = await request(`${API}/health`); return r.ok ? `âœ… ì„œë²„ ì •ìƒ\nì‹œê°„: ${new Date(r.data.ts).toLocaleString()}` : `âŒ ì‹¤íŒ¨: ${r.error}`; },
                help: async () => { const r = await request(`${API}/help`); return r.ok ? `âœ… API ë¬¸ì„œ\nì—”ë“œí¬ì¸íŠ¸: ${Object.keys(r.data.endpoints).length}` : `âŒ ì‹¤íŒ¨: ${r.error}`; },
                metrics: async () => { const r = await request(`${API}/metrics`); return r.ok ? `âœ… ë©”íŠ¸ë¦­ìŠ¤\nìš”ì²­ ìˆ˜: ${r.data.totalRequests || 'N/A'}` : `âŒ ì‹¤íŒ¨: ${r.error}`; },
                trending: async () => { const s = performance.now(); const r = await request(`${API}/trending`); const ms = (performance.now() - s).toFixed(1); return r.ok ? `âœ… Trending ${ms}ms source=${r.data.source}` : `âŒ ì‹¤íŒ¨: ${r.error}`; },
                chat: async () => { const r = await request(`${API}/chat/test/messages`); return r.ok ? `âœ… ì±„íŒ… ë©”ì‹œì§€ ${(r.data.messages || []).length}ê°œ` : `âŒ ì‹¤íŒ¨: ${r.error}`; }
            };
            const id = ['health', 'help', 'metrics'].includes(kind) ? 'server-result' : kind === 'trending' ? 'trending-result' : 'chat-result';
            show(id, 'â³ ì§„í–‰ ì¤‘...', 'info'); const out = await map[kind](); show(id, out, out.startsWith('âœ…') ? 'success' : 'error');
        }
        async function testPerformance() { show('trending-result', 'âš¡ ì„±ëŠ¥ 5íšŒ...', 'info'); const times = []; const sources = []; for (let i = 0; i < 5; i++) { const s = performance.now(); const r = await request(`${API}/trending`); const ms = performance.now() - s; times.push(ms); if (r.ok) sources.push(r.data.source); } const avg = (times.reduce((a, b) => a + b) / times.length).toFixed(1); show('trending-result', `âœ… í‰ê·  ${avg}ms ì†ŒìŠ¤: ${[...new Set(sources)].join(' â†’ ')}`, 'success'); }
        async function multiTrending() { show('trending-multi-result', 'â³ 10íšŒ ìˆ˜í–‰...', 'info'); const times = []; const srcSet = new Set(); for (let i = 0; i < 10; i++) { const s = performance.now(); const r = await request(`${API}/trending`); const ms = performance.now() - s; times.push(ms); if (r.ok) srcSet.add(r.data.source); await new Promise(rz => setTimeout(rz, 50)); } const avg = (times.reduce((a, b) => a + b, 0) / times.length).toFixed(1); show('trending-multi-result', `âœ… 10íšŒ í‰ê·  ${avg}ms sources=[${[...srcSet].join(',')}]`, 'success'); }
        async function sendMessage() { const msg = document.getElementById('msg').value; if (!msg.trim()) return show('chat-result', 'âŒ ë©”ì‹œì§€ í•„ìš”', 'error'); show('chat-result', 'ğŸ“¤ ì „ì†¡...', 'info'); const r = await request(`${API}/chat/test/messages`, { method: 'POST', body: JSON.stringify({ content: msg, author: 'í…ŒìŠ¤í„°' }) }); show('chat-result', r.ok ? `âœ… ì „ì†¡ ì„±ê³µ id=${r.data.message?.id}` : `âŒ ì‹¤íŒ¨: ${r.error}`, r.ok ? 'success' : 'error'); }
        function sendRandomMessage() {
            const samples = ['ëœë¤ğŸ˜€', 'Ping', 'Stress ' + Math.random().toString(36).slice(2, 8), 'LoadTest', 'Echo', 'í…ŒìŠ¤íŠ¸' + Date.now()];
            document.getElementById('msg').value = samples[Math.floor(Math.random() * samples.length)];
            sendMessage();
        }
        async function checkSecurity() { show('security-result', 'ğŸ” í™•ì¸ ì¤‘...', 'info'); try { const resp = await fetch(`${API}/health`); const csp = resp.headers.get('Content-Security-Policy'); const cors = resp.headers.get('Access-Control-Allow-Origin'); const frame = resp.headers.get('X-Frame-Options'); show('security-result', `âœ… ë³´ì•ˆ í—¤ë”\nCSP:${csp ? 'ìˆìŒ' : 'ì—†ìŒ'}\nCORS:${cors || 'ì—†ìŒ'}\nX-Frame:${frame || 'ì—†ìŒ'}`, 'success'); } catch (e) { show('security-result', `âŒ ì‹¤íŒ¨: ${e.message}`, 'error'); } }
        // runAllSmoke ì œê±°ë¨ -> runChecklist(true)ë¡œ ëŒ€ì²´

        let latestTimer = null;
        async function loadLatest500() {
            show('latest500-summary', 'â³ ë¡œë”©...', 'info');
            const communities = ['free', 'news', 'game', 'image', 'default', 'test'];
            // ë³‘ë ¬ fetch
            const fetches = await Promise.all(communities.map(c => fetch(`${API}/chat/${c}/messages?limit=500`).then(r => r.json().catch(() => ({ error: true }))).catch(() => ({ error: true }))));
            let merged = [];
            const perStat = [];
            fetches.forEach((res, idx) => {
                const name = communities[idx];
                if (res && !res.error && res.messages) {
                    perStat.push(`${name}:${res.messages.length}`);
                    res.messages.forEach(m => {
                        const ts = Date.parse(m.timestamp || m.created_at || m.createdAt || m.time || Date.now());
                        merged.push({
                            community: name,
                            id: m.id,
                            author: m.author || m.username || 'ìµëª…',
                            content: m.content,
                            ts
                        });
                    });
                } else {
                    perStat.push(`${name}:ERR`);
                }
            });
            merged.sort((a, b) => b.ts - a.ts);
            if (merged.length > 500) merged = merged.slice(0, 500);
            const listBox = document.getElementById('latest500-list');
            listBox.textContent = merged.map(m => {
                const t = new Date(m.ts).toLocaleTimeString();
                return `[${t}][${m.community}] ${m.author}: ${m.content}`;
            }).join('\n');
            show('latest500-summary', `âœ… ì´ ${merged.length}ê°œ (ì»¤ë®¤ë‹ˆí‹°ë³„: ${perStat.join(', ')})`, 'success');
        }
        function autoRefreshLatest() {
            if (latestTimer) return; loadLatest500();
            latestTimer = setInterval(loadLatest500, 30000);
            show('latest500-summary', 'ğŸ” 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨ í™œì„±', 'info');
        }
        function stopAutoRefreshLatest() {
            if (latestTimer) { clearInterval(latestTimer); latestTimer = null; show('latest500-summary', 'â¹ï¸ ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€', 'info'); }
        }
        async function fetchMe() {
            if (!ACCESS_TOKEN) return show('google-login-result', 'âŒ í† í° ì—†ìŒ', 'error');
            const r = await request(API + '/auth/me');
            if (r.ok) {
                show('google-login-result', 'âœ… /me\nuserId=' + r.data.user.id + '\nname=' + r.data.user.display_name + '\nemail=' + (r.data.user.email || '') + '\nidentities=' + r.data.user.identities.length, 'success');
            } else show('google-login-result', 'âŒ /me ì‹¤íŒ¨ ' + r.error, 'error');
        }
        function logoutAll() {
            ACCESS_TOKEN = null;
            LAST_GOOGLE_EMAIL = null;
            logChecklist('ğŸ”’ ë¡œê·¸ì•„ì›ƒ/í† í° ì´ˆê¸°í™” ì™„ë£Œ');
            show('google-login-result', 'ë¡œê·¸ì•„ì›ƒë¨', 'info');
        }
        async function createPost() {
            if (!ACCESS_TOKEN) return show('post-create-result', 'âŒ ë¨¼ì € ë¡œê·¸ì¸ í•„ìš”', 'error');
            const board = document.getElementById('post-board').value.trim();
            const title = document.getElementById('post-title').value.trim();
            const content = document.getElementById('post-content').value;
            if (!board || !title) return show('post-create-result', 'âŒ board/title í•„ìš”', 'error');
            show('post-create-result', 'â³ ìƒì„± ì¤‘...', 'info');
            const res = await request(`${API}/boards/${board}/posts`, { method: 'POST', body: JSON.stringify({ title, content }) });
            if (!res.ok) return show('post-create-result', 'âŒ ì‹¤íŒ¨ ' + res.error, 'error');
            const pid = res.data.id;
            // ìƒì„¸ ì¡°íšŒ
            const detail = await request(`${API}/posts/${pid}`);
            if (detail.ok) {
                show('post-create-result', `âœ… ìƒì„±ë¨ id=${pid}\nboard=${board}\nauthor=${detail.data.author}\ntitle=${detail.data.title}`, 'success');
            } else {
                show('post-create-result', `âš ï¸ ìƒì„±ì€ ë˜ì—ˆìœ¼ë‚˜ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨ id=${pid}`, 'error');
            }
        }

        // --- Google Identity Services (Enhanced) ---
        // Client ID updated (2025-09-21): previous n38qlgmu... replaced with rl00r389... per request
        const GOOGLE_CID = '425966176847-rl00r389id6rc891fmcsi98ab3cneak2.apps.googleusercontent.com';
        let LAST_GOOGLE_EMAIL = null;
        let REAL_LOGIN_IN_PROGRESS = false;

        async function exchangeGoogleToken(idToken) {
            if (REAL_LOGIN_IN_PROGRESS) return;
            REAL_LOGIN_IN_PROGRESS = true;
            show('google-login-result', 'â³ ì„œë²„ í† í° êµí™˜ ì¤‘...', 'info');
            try {
                const r = await fetch(API + '/auth/google', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ idToken }) });
                const js = await r.json().catch(() => ({}));
                if (r.ok && js.access) {
                    ACCESS_TOKEN = js.access;
                    show('google-login-result', `âœ… ë¡œê·¸ì¸ ì„±ê³µ\nemail=${LAST_GOOGLE_EMAIL || '(unknown)'}\nmode=real`, 'success');
                    logChecklist('auth: real login ok', 'success');
                } else {
                    show('google-login-result', 'âŒ êµí™˜ ì‹¤íŒ¨ ' + (js.error || r.status), 'error');
                    logChecklist('auth exchange fail: ' + (js.error || r.status), 'error');
                }
            } catch (e) {
                show('google-login-result', 'âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + e.message, 'error');
                logChecklist('auth exchange net err: ' + e.message, 'error');
            } finally {
                REAL_LOGIN_IN_PROGRESS = false;
            }
        }

        async function handleGoogleCredential(resp) {
            try {
                if (resp && resp.credential) {
                    const idToken = resp.credential;
                    const isTestMode = idToken.startsWith('test-google:');
                    if (!isTestMode) {
                        try {
                            const parts = idToken.split('.');
                            if (parts.length >= 2) {
                                const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
                                LAST_GOOGLE_EMAIL = payload.email || null;
                                const nowSec = Math.floor(Date.now() / 1000);
                                let warn = '';
                                if (payload.aud && payload.aud !== GOOGLE_CID) warn += `aud mismatch(expected ${GOOGLE_CID} got ${payload.aud}) `;
                                if (payload.exp && payload.exp < nowSec) warn += 'token expired ';
                                else if (payload.exp && payload.exp - nowSec < 60) warn += 'token expiring(<60s) ';
                                if (warn) {
                                    logChecklist('âš ï¸ Google í† í° ê²½ê³ : ' + warn.trim(), 'error');
                                    const box = document.getElementById('google-login-result');
                                    if (box) box.textContent += `\n[ê²½ê³ ] ${warn.trim()}`;
                                } else {
                                    logChecklist('Google í† í° aud/exp ì •ìƒ', 'info');
                                }
                            }
                        } catch { }
                        await exchangeGoogleToken(idToken);
                    } else {
                        show('google-login-result', 'âš ï¸ test-mode í† í° ìˆ˜ì‹  (ì²´í¬ë¦¬ìŠ¤íŠ¸ìš©)', 'info');
                    }
                }
            } catch (e) {
                show('google-login-result', 'âŒ credential ì²˜ë¦¬ ì‹¤íŒ¨ ' + e.message, 'error');
            }
        }

        function initGoogle() {
            if (!(window.google && google.accounts && google.accounts.id)) return;
            try {
                google.accounts.id.initialize({ client_id: GOOGLE_CID, callback: handleGoogleCredential, ux_mode: 'popup' });
                google.accounts.id.renderButton(document.getElementById('g_id_signin'), { theme: 'outline', size: 'large', width: 250 });
            } catch (e) {
                show('google-login-result', 'âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + e.message, 'error');
            }
        }

        function enhanceMultiAccount() {
            try { if (window.google && google.accounts && google.accounts.id) google.accounts.id.disableAutoSelect(); } catch { }
            const box = document.getElementById('google-auth-box');
            if (box && !document.getElementById('google-reset-btn')) {
                const btn = document.createElement('button');
                btn.id = 'google-reset-btn';
                btn.style.background = '#8b5cf6';
                btn.textContent = 'ğŸ”„ ê³„ì • ë³€ê²½ / ì¬ì„ íƒ';
                btn.onclick = async () => {
                    try {
                        if (window.google && google.accounts && google.accounts.id) {
                            google.accounts.id.revoke(LAST_GOOGLE_EMAIL || undefined, () => {
                                show('google-login-result', 'â™»ï¸ ê³„ì • ì„¸ì…˜ ì´ˆê¸°í™”, ë‹¤ì‹œ ì„ íƒì°½ ìš”ì²­ ì¤‘...', 'info');
                                setTimeout(() => { try { google.accounts.id.prompt(n => { if (n.isNotDisplayed && n.isNotDisplayed()) show('google-login-result', 'âš ï¸ í‘œì‹œ ì‹¤íŒ¨: ' + n.getNotDisplayedReason(), 'error'); }); } catch (e) { show('google-login-result', 'âŒ prompt ì˜¤ë¥˜: ' + e.message, 'error'); } }, 300);
                            });
                        } else {
                            show('google-login-result', 'âŒ Google SDK ì¤€ë¹„ ì•ˆë¨', 'error');
                        }
                    } catch (e) {
                        show('google-login-result', 'âŒ ê³„ì • ì´ˆê¸°í™” ì‹¤íŒ¨: ' + e.message, 'error');
                    }
                };
                const firstDiv = box.querySelector('div');
                if (firstDiv) firstDiv.appendChild(btn);
            }
        }

        function attachCustomGoogleButton() {
            const btn = document.getElementById('custom-google-btn');
            if (!btn || btn._gBound) return;
            btn._gBound = true;
            btn.addEventListener('click', () => {
                if (!(window.google && google.accounts && google.accounts.id)) {
                    show('google-login-result', 'âŒ Google SDK ë¯¸ì´ˆê¸°í™”', 'error');
                    return;
                }
                show('google-login-result', 'â³ ë¡œê·¸ì¸ íŒì—… ìš”ì²­...', 'info');
                try {
                    google.accounts.id.prompt(n => {
                        try {
                            if (!n) return;
                            if (n.isNotDisplayed && n.isNotDisplayed()) show('google-login-result', 'âš ï¸ í‘œì‹œ ì‹¤íŒ¨: ' + n.getNotDisplayedReason(), 'error');
                            else if (n.isSkippedMoment && n.isSkippedMoment()) show('google-login-result', 'âš ï¸ ìŠ¤í‚µ: ' + n.getSkippedReason(), 'error');
                        } catch { }
                    });
                } catch (e) {
                    show('google-login-result', 'âŒ prompt ì˜¤ë¥˜: ' + e.message, 'error');
                }
            });
        }

        async function testGoogleTestMode() {
            show('google-login-result', 'â³ test-mode ë¡œê·¸ì¸...', 'info');
            try {
                const fake = 'test-google:manual:' + Date.now() + ':tester@test.local';
                const r = await fetch(API + '/auth/google', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ idToken: fake }) });
                const js = await r.json().catch(() => ({}));
                if (r.ok && js.access) { ACCESS_TOKEN = js.access; show('google-login-result', 'âœ… test-mode ë¡œê·¸ì¸ ì„±ê³µ', 'success'); logChecklist('auth: test-mode login ok', 'success'); }
                else show('google-login-result', 'âŒ test-mode ì‹¤íŒ¨ ' + (js.error || r.status), 'error');
            } catch (e) { show('google-login-result', 'âŒ test-mode ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ' + e.message, 'error'); }
        }

        function initGoogleEnhanced() { try { initGoogle(); } catch { } enhanceMultiAccount(); attachCustomGoogleButton(); }

        // Google ìŠ¤í¬ë¦½íŠ¸ ë¡œë” (ê¸°ì¡´ ìœ ì§€)
        window.addEventListener('load', () => {
            const s = document.createElement('script');
            s.src = 'https://accounts.google.com/gsi/client';
            s.async = true; s.defer = true; s.onload = initGoogleEnhanced; s.onerror = () => show('google-login-result', 'âŒ êµ¬ê¸€ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨', 'error');
            document.head.appendChild(s);
        });

        // ì²´í¬ë¦¬ìŠ¤íŠ¸ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸
        function logChecklist(msg, type = 'info') { const box = document.getElementById('checklist-log'); if (!box) return; const prev = box.textContent === 'ëŒ€ê¸° ì¤‘' ? '' : box.textContent + '\n'; box.className = 'result ' + (type === 'error' ? 'error' : type === 'success' ? 'success' : 'info'); box.textContent = prev + msg; }
        function mark(id, ok, extra = '') { const el = document.getElementById(id); if (!el) return; const prefix = ok ? '[âœ”]' : '[âœ–]'; el.textContent = prefix + ' ' + el.textContent.replace(/^\[[^\]]+\]\s*/, '').split(' (')[0] + (extra ? ` (${extra})` : ''); if (ok) el.style.color = '#047857'; else el.style.color = '#dc2626'; }
        // ì „ì—­ ì²´í¬ë¦¬ìŠ¤íŠ¸ ê²°ê³¼ ì €ì¥ ê°ì²´
        let CHECK_RESULTS = {};
        function resetChecklist() {
            CHECK_RESULTS = {};
            ['cl-health', 'cl-help', 'cl-metrics', 'cl-trending', 'cl-trending-perf', 'cl-home', 'cl-search', 'cl-boards', 'cl-categories', 'cl-metrics-latency', 'cl-chat-load', 'cl-login', 'cl-me', 'cl-post', 'cl-chat', 'cl-latest500', 'cl-security'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = el.textContent.replace(/^[\[[^\]]+\]\s*/, '[ ] ');
                    el.style.color = '';
                }
            });
            const box = document.getElementById('checklist-log');
            if (box) { box.textContent = 'ëŒ€ê¸° ì¤‘'; box.className = 'result info'; }
        }
        // TEST ì •ì˜ë¥¼ runChecklist ë°–ì—ì„œë„ ì¬ì‚¬ìš© (ì‹¤íŒ¨ ì¬ì‹œë„) í•˜ê¸° ìœ„í•´ íŒ©í† ë¦¬ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
        function buildTests() {
            return [
                { id: 'cl-health', key: 'health', run: async () => { const r = await request(API + '/health'); return { ok: r.ok, extra: '', raw: r }; } },
                { id: 'cl-help', key: 'help', run: async () => { const r = await request(API + '/help'); const ep = r.ok ? Object.keys(r.data.endpoints || {}).length : 0; return { ok: r.ok, extra: r.ok ? 'endpoints=' + ep : '', raw: r }; } },
                { id: 'cl-metrics', key: 'metrics', run: async () => { const r = await request(API + '/metrics'); return { ok: r.ok, extra: r.ok ? 'totalRequests=' + (r.data.totalRequests || 'N/A') : '', raw: r }; } },
                { id: 'cl-trending', key: 'trending', run: async () => { const s = performance.now(); const r = await request(API + '/trending'); const ms = (performance.now() - s).toFixed(0) + 'ms'; return { ok: r.ok, extra: r.ok ? ms + ' ' + r.data.source : '', raw: r }; } },
                { id: 'cl-trending-perf', key: 'trending_perf', run: async () => { let times = []; let sources = new Set(); for (let i = 0; i < 5; i++) { const s = performance.now(); const r = await request(API + '/trending'); const ms = performance.now() - s; if (r.ok) sources.add(r.data.source); times.push(ms); } const avg = times.length ? (times.reduce((a, b) => a + b, 0) / times.length).toFixed(0) : '0'; return { ok: times.length === 5, extra: `avg=${avg}ms src=${[...sources].join('+')}`, raw: { samples: times } }; } },
                { id: 'cl-home', key: 'home', run: async () => { const s = performance.now(); const r = await request(API + '/home'); const ms = (performance.now() - s).toFixed(0); if (!r.ok) return { ok: false, extra: '', raw: r }; const an = (r.data.announcements || []).length; const ev = (r.data.events || []).length; return { ok: true, extra: `ann=${an} ev=${ev} ${ms}ms`, raw: r }; } },
                {
                    id: 'cl-search', key: 'search', run: async () => { // íƒìƒ‰ì : í‚¤ì›Œë“œ 'test'
                        try { const s = performance.now(); const r = await request(API + '/search?q=test&limit=5'); if (!r.ok) return { ok: false, extra: 'fail', raw: r }; const ms = (performance.now() - s).toFixed(0); const cnt = (r.data.results || r.data.items || []).length; return { ok: true, extra: `cnt=${cnt} ${ms}ms`, raw: r }; } catch (e) { return { ok: false, extra: 'no-endpoint', raw: { error: e.message } }; }
                    }
                },
                { id: 'cl-boards', key: 'boards', run: async () => { const r = await request(API + '/boards'); if (!r.ok) return { ok: false, extra: '', raw: r }; const cnt = (r.data.boards || r.data || []).length; return { ok: true, extra: 'cnt=' + cnt, raw: r }; } },
                { id: 'cl-categories', key: 'categories', run: async () => { const r = await request(API + '/categories'); if (!r.ok) return { ok: false, extra: '', raw: r }; const cnt = (r.data.categories || r.data || []).length; return { ok: true, extra: 'cnt=' + cnt, raw: r }; } },
                {
                    id: 'cl-metrics-latency', key: 'metrics_latency', run: async () => {
                        try {
                            const resp = await fetch(API + '/metrics-prom');
                            const txt = await resp.text();
                            const lines = txt.split('\n');
                            let latency = null; let label = '';
                            const pick = ['client_lcp_p90', 'client_inp_p90', 'client_fcp_p90'];
                            for (const k of pick) {
                                const ln = lines.find(l => l.startsWith(k + ' '));
                                if (ln) { latency = parseFloat(ln.split(' ')[1]); label = k; break; }
                            }
                            if (!latency) {
                                const avgLn = lines.find(l => l.startsWith('http_request_duration_ms_avg '));
                                if (avgLn) { latency = parseFloat(avgLn.split(' ')[1]); label = 'http_avg'; }
                            }
                            if (latency == null) return { ok: false, extra: 'no-metrics', raw: { text: txt.slice(0, 300) } };
                            const warn = latency > 1500;
                            return { ok: true, extra: `${label}=${latency.toFixed(0)}ms` + (warn ? 'âš ' : ''), raw: { latency, label } };
                        } catch (e) { return { ok: false, extra: 'fetch-error', raw: { error: e.message } }; }
                    }
                },
                { id: 'cl-chat-load', key: 'chat_load', run: async () => { try { const stats = await runChatLoadInternal(true); return { ok: true, extra: `avg=${stats.avg} p90=${stats.p90} p99=${stats.p99}`, raw: stats }; } catch (e) { return { ok: false, extra: 'err', raw: { error: e.message } }; } } },
                { id: 'cl-login', key: 'login', run: async () => { if (ACCESS_TOKEN) { return { ok: true, extra: 'existing', raw: { reused: true } }; } const lg = await fetch(API + '/auth/google', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ idToken: 'test-google:cluser:cluser@test.local' }) }); const js = await lg.json().catch(() => ({})); if (lg.ok) { ACCESS_TOKEN = js.access; return { ok: true, extra: 'test-mode', raw: js }; } return { ok: false, extra: js.error || lg.status, raw: js }; } },
                { id: 'cl-me', key: 'me', run: async () => { const r = await request(API + '/auth/me'); return { ok: r.ok, extra: r.ok ? 'ids=' + (r.data.user.identities || []).length : '', raw: r }; } },
                { id: 'cl-post', key: 'post', run: async () => { const me = await request(API + '/auth/me'); if (!me.ok) return { ok: false, extra: 'no-auth', raw: me }; const pc = await request(`${API}/boards/free/posts`, { method: 'POST', body: JSON.stringify({ title: 'CL Test ' + Date.now(), content: 'Checklist post' }) }); if (!pc.ok) return { ok: false, extra: pc.error, raw: pc }; const pid = pc.data.id; const det = await request(`${API}/posts/${pid}`); const authorOk = det.ok && det.data.author === me.data.user.display_name; return { ok: det.ok && authorOk, extra: authorOk ? 'author ok' : 'author mismatch', raw: { create: pc, detail: det } }; } },
                { id: 'cl-chat', key: 'chat', run: async () => { const chatMsg = 'cl chat ' + Date.now(); const cp = await request(API + '/chat/test/messages', { method: 'POST', body: JSON.stringify({ content: chatMsg, author: 'CLBot' }) }); const cg = await request(API + '/chat/test/messages'); const found = cg.ok && (cg.data.messages || []).some(m => m.content === chatMsg); const chatOk = cp.ok && cg.ok && found; return { ok: chatOk, extra: found ? 'ok' : 'not found', raw: { post: cp, get: cg } }; } },
                { id: 'cl-latest500', key: 'latest500', run: async () => { const comms = ['free', 'news', 'game', 'image', 'default', 'test']; let okLatest = true; let total = 0; for (const c of comms) { const r = await request(`${API}/chat/${c}/messages?limit=10`); if (!r.ok) { okLatest = false; break; } total += (r.data.messages || []).length; } return { ok: okLatest, extra: 'sum=' + total, raw: { total } }; } },
                {
                    id: 'cl-security', key: 'security', run: async () => {
                        try {
                            const resp = await fetch(API + '/health');
                            const csp = resp.headers.get('Content-Security-Policy');
                            const xcto = resp.headers.get('X-Content-Type-Options');
                            const xfo = resp.headers.get('X-Frame-Options');
                            const rp = resp.headers.get('Referrer-Policy');
                            const pp = resp.headers.get('Permissions-Policy');
                            const missing = [];
                            if (!csp) missing.push('csp');
                            if (!xcto) missing.push('xcto');
                            if (!xfo) missing.push('xfo');
                            if (!rp) missing.push('rp');
                            if (!pp) missing.push('pp');
                            const ok = missing.length === 0;
                            const extra = ok ? 'all' : ('miss:' + missing.join(','));
                            return { ok, extra, raw: { csp, xcto, xfo, rp, pp } };
                        } catch (e) { return { ok: false, extra: 'fetch error', raw: { error: e.message } }; }
                    }
                }
            ];
        }
        function percentile(arr, p) { if (!arr.length) return 0; const s = [...arr].sort((a, b) => a - b); const idx = Math.min(s.length - 1, Math.floor(p * s.length)); return s[idx]; }
        async function runChatLoadInternal(internal = false) {
            const N = parseInt(document.getElementById('chat-load-n')?.value || '30', 10);
            const C = parseInt(document.getElementById('chat-load-c')?.value || '5', 10);
            const delays = [];
            let sent = 0;
            async function worker() {
                while (true) {
                    const i = sent++; if (i >= N) break;
                    const msg = 'load ' + i + ' ' + Math.random().toString(36).slice(2, 6);
                    const s = performance.now();
                    await request(`${API}/chat/test/messages`, { method: 'POST', body: JSON.stringify({ content: msg, author: 'LoadBot' }) });
                    delays.push(performance.now() - s);
                }
            }
            const workers = []; for (let i = 0; i < C; i++) workers.push(worker());
            await Promise.all(workers);
            const avg = delays.length ? (delays.reduce((a, b) => a + b, 0) / delays.length) : 0;
            const p90 = percentile(delays, 0.90).toFixed(0);
            const p99 = percentile(delays, 0.99).toFixed(0);
            if (!internal) {
                show('chat-load-result', `âœ… N=${N} C=${C} avg=${avg.toFixed(1)}ms p90=${p90} p99=${p99}`, 'success');
            }
            return { N, C, count: delays.length, avg: avg.toFixed(1), p90, p99 };
        }
        async function runChatLoad() { show('chat-load-result', 'â³ ì‹¤í–‰ ì¤‘...', 'info'); try { await runChatLoadInternal(false); } catch (e) { show('chat-load-result', 'âŒ ì‹¤íŒ¨ ' + e.message, 'error'); } }
        async function runChecklist() {
            logChecklist('ì²´í¬ë¦¬ìŠ¤íŠ¸ ì‹œì‘');
            const TESTS = buildTests();
            const failList = [];
            const startAll = performance.now();
            for (const t of TESTS) {
                const start = performance.now();
                let res;
                try { res = await t.run(); } catch (e) { res = { ok: false, extra: 'exception', raw: { error: e.message } }; }
                const ms = (performance.now() - start).toFixed(0);
                CHECK_RESULTS[t.key] = { ...res, ms: Number(ms) };
                mark(t.id, res.ok, (res.extra ? res.extra + ' ' : '') + ms + 'ms');
                logChecklist(`${t.key}: ${res.ok ? 'ok' : 'fail'} (${ms}ms)` + (res.extra ? ' ' + res.extra : ''), res.ok ? 'info' : 'error');
                if (!res.ok) failList.push(t.key);
            }
            const took = (performance.now() - startAll).toFixed(0);
            const passed = TESTS.length - failList.length;
            CHECK_RESULTS['summary'] = { passed, total: TESTS.length, failed: failList, ms: Number(took) };
            const summary = `=== ìš”ì•½ ===\nì´ ${TESTS.length}ê°œ ì¤‘ ${passed}ê°œ ì„±ê³µ (${took}ms)` + (failList.length ? `\nì‹¤íŒ¨: ${failList.join(', ')}` : '\nëª¨ë‘ ì„±ê³µ âœ…');
            logChecklist(summary, failList.length ? 'error' : 'success');
        }
        async function retryFailed() {
            const prev = CHECK_RESULTS['summary'];
            if (!prev || !prev.failed || !prev.failed.length) {
                logChecklist('ì¬ì‹œë„í•  ì‹¤íŒ¨ í•­ëª© ì—†ìŒ');
                return;
            }
            logChecklist('ì‹¤íŒ¨ í•­ëª© ì¬ì‹œë„: ' + prev.failed.join(', '));
            const tests = buildTests().filter(t => prev.failed.includes(t.key));
            const newFails = [];
            for (const t of tests) {
                const start = performance.now();
                let res; try { res = await t.run(); } catch (e) { res = { ok: false, extra: 'exception', raw: { error: e.message } }; }
                const ms = (performance.now() - start).toFixed(0);
                CHECK_RESULTS[t.key] = { ...res, ms: Number(ms), retried: true };
                mark(t.id, res.ok, (res.extra ? res.extra + ' ' : '') + ms + 'ms');
                logChecklist(`(ì¬) ${t.key}: ${res.ok ? 'ok' : 'fail'} (${ms}ms)` + (res.extra ? ' ' + res.extra : ''), res.ok ? 'info' : 'error');
                if (!res.ok) newFails.push(t.key);
            }
            // ê¸°ì¡´ ì‹¤íŒ¨ ì¤‘ ë³µêµ¬ëœ í•­ëª© ë°˜ì˜
            const still = newFails;
            const allTests = buildTests();
            const passed = allTests.length - still.length;
            CHECK_RESULTS['summary'] = { passed, total: allTests.length, failed: still, ms: CHECK_RESULTS.summary ? CHECK_RESULTS.summary.ms : undefined, retriedAt: Date.now() };
            logChecklist(`ì¬ì‹œë„ ì™„ë£Œ. ë‚¨ì€ ì‹¤íŒ¨: ${still.length ? still.join(', ') : 'ì—†ìŒ âœ…'}`, still.length ? 'error' : 'success');
        }
        function exportChecklistJson() {
            try {
                const blob = new Blob([JSON.stringify(CHECK_RESULTS, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                const ts = new Date().toISOString().replace(/[:.]/g, '-');
                a.download = `checklist-results-${ts}.json`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 500);
                logChecklist('ê²°ê³¼ JSON export ì™„ë£Œ');
            } catch (e) {
                logChecklist('Export ì‹¤íŒ¨: ' + e.message, 'error');
            }
        }
        // file:// ë¡œ ì—´ì—ˆëŠ”ì§€ ê°ì§€í•˜ì—¬ ê²½ê³  (checklist-log ì‚¬ìš©)
        if (location.protocol === 'file:') {
            setTimeout(() => { const box = document.getElementById('checklist-log'); if (box && /ëŒ€ê¸° ì¤‘/.test(box.textContent)) { logChecklist('âš ï¸ file:// ë¡œ ì—´ë¦¼: fetch / Google ë¡œê·¸ì¸ ì œí•œ ê°€ëŠ¥. http://localhost ì‚¬ìš© ê¶Œì¥', 'error'); } }, 200);
        }
    </script>
</body>

</html>